<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>QR 코드 스캔</title>
<style>
  body {
    margin: 0; padding: 0;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    background: #f1f1f1;
    position: relative;
  }

  #backBtn {
    position: absolute;
    top: 20px;
    left: 20px;
    font-size: 48px;
    background: none;
    border: none;
    color: #2e7d32;
    font-weight: bold;
    cursor: pointer;
    z-index: 10;
  }

  h2 {
    margin-top: 100px;
    font-size: 64px;
    color: #2e7d32;
  }

  #video {
    width: 100vw;
    height: auto;
    max-width: 600px;
    border-radius: 16px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
  }

  /* 결과 텍스트 영역 제거 (아예 안 보여줌) */
</style>
</head>
<body>

<button id="backBtn" onclick="location.href='index.html'">&lt; 뒤로가기</button>

<h2>QR 코드 스캔</h2>

<video id="video" playsinline></video>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
  const team = localStorage.getItem("team");
  if (!team) {
    alert("로그인이 필요합니다.");
    location.href = "index.html";
  }

  const codeReader = new ZXing.BrowserQRCodeReader();
  const videoElement = document.getElementById('video');

  // 서버 URL (구글 스프레드시트용 Google Apps Script Web App URL 등)
  const SERVER_URL = 'https://your-google-apps-script-webapp-url';

  // 위치 정보 얻기 함수 (비동기)
  async function getLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        resolve({latitude: null, longitude: null});
      } else {
        navigator.geolocation.getCurrentPosition(
          pos => resolve({latitude: pos.coords.latitude, longitude: pos.coords.longitude}),
          err => resolve({latitude: null, longitude: null}),
          {timeout: 10000}
        );
      }
    });
  }

  // 서버에 데이터 전송 함수
  async function sendData(qrText) {
    const loc = await getLocation();
    const now = new Date();
    const data = {
      team: team,
      qrData: qrText,
      latitude: loc.latitude,
      longitude: loc.longitude,
      datetime: now.toISOString()
    };

    fetch(SERVER_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    })
    .then(res => {
      if (!res.ok) throw new Error('서버 응답 오류');
      alert('출석 정보가 기록되었습니다.');
      // 스캔 후 페이지 이동이나 추가 작업 가능
      // location.href = 'index.html';  // 예: 로그인 페이지로 이동
    })
    .catch(err => {
      alert('데이터 전송 실패: ' + err.message);
      // 필요 시 재시도 기능 추가 가능
    });
  }

  // 페이지 로드와 동시에 카메라 켜고 스캔 시작
  codeReader.getVideoInputDevices()
    .then(videoInputDevices => {
      const rearCamera = videoInputDevices.find(device =>
        device.label.toLowerCase().includes('back') ||
        device.label.toLowerCase().includes('rear')
      ) || videoInputDevices[0];

      codeReader.decodeFromVideoDevice(rearCamera.deviceId, videoElement, async (result, err) => {
        if (result) {
          codeReader.reset(); // 스캔 성공 시 카메라 정지
          await sendData(result.text);
        }
        if (err && !(err instanceof ZXing.NotFoundException)) {
          console.error(err);
        }
      });
    })
    .catch(err => {
      console.error(err);
      alert("카메라를 찾을 수 없습니다.");
    });
</script>

</body>
</html>
