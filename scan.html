<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>QR 출석</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f0f0f0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #backBtn {
      position: absolute;
      top: 30px;
      left: 20px;
      font-size: 48px;
      background: none;
      border: none;
      color: #2e7d32;
      font-weight: bold;
      cursor: pointer;
    }

    h2 {
      font-size: 64px;
      margin-top: 100px;
    }

    p {
      font-size: 48px;
      margin: 20px 0;
    }

    #scanBtn {
      font-size: 48px;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      background-color: #2e7d32;
      color: white;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      margin-top: 40px;
    }

    #reader {
      margin-top: 40px;
      width: 100%;
      max-width: 600px;
      height: 60vh;
      border-radius: 16px;
      background-color: #000;
    }

    #result {
      font-size: 40px;
      margin-top: 30px;
      color: #333;
    }
  </style>
</head>
<body>
  <button id="backBtn" onclick="location.href='login.html'">&lt; 뒤로가기</button>

  <h2>QR코드 출석</h2>
  <p>팀: <span id="teamName"></span></p>
  <p>이름: <span id="userName"></span></p>

  <button id="scanBtn">📷 QR 코드 스캔 시작</button>
  <div id="result"></div>
  <div id="reader"></div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    const team = localStorage.getItem("team") || "알 수 없음";
    const name = localStorage.getItem("name") || "이름 없음";
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycb.../exec"; // 스프레드시트 URL로 변경

    document.getElementById("teamName").textContent = team;
    document.getElementById("userName").textContent = name;

    function getLocationAndSend(qrData) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          const timestamp = new Date().toLocaleString();

          fetch(GOOGLE_SCRIPT_URL +
            `?team=${encodeURIComponent(team)}&name=${encodeURIComponent(name)}&qr=${encodeURIComponent(qrData)}&lat=${latitude}&lon=${longitude}&time=${encodeURIComponent(timestamp)}`)
            .then((res) => res.text())
            .then(() => {
              document.getElementById("result").textContent = "✅ 출석 완료!";
            })
            .catch((err) => {
              document.getElementById("result").textContent = "❌ 오류 발생!";
              console.error(err);
            });
        },
        () => {
          alert("위치 정보를 가져올 수 없습니다.");
        }
      );
    }

    document.getElementById("scanBtn").addEventListener("click", () => {
      const html5QrCode = new Html5Qrcode("reader");

      Html5Qrcode.getCameras()
        .then((devices) => {
          const backCam = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
          html5QrCode.start(
            backCam.id,
            { fps: 10, qrbox: { width: 400, height: 400 } },
            (decodedText) => {
              html5QrCode.stop();
              getLocationAndSend(decodedText);
            },
            (errorMessage) => { /* 무시 */ }
          );
        })
        .catch(() => alert("카메라를 사용할 수 없습니다."));
    });
  </script>
</body>
</html>
