<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR 코드 스캔</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-size: 28px;
      display: flex; flex-direction: column;
    }
    #back-button {
      font-size: 28px;
      padding: 10px 20px;
      background: none;
      border: none;
      color: #007bff;
      cursor: pointer;
      text-align: left;
      user-select: none;
      outline: none;
    }
    #reader {
      flex: 1;
      width: 100%;
    }
  </style>
</head>
<body>

<button id="back-button" onclick="goBack()">&lt; 뒤로가기</button>

<div id="reader"></div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  // 구글 앱스크립트 웹앱 URL (본인 것이 맞는지 꼭 확인하세요)
  const SERVER_URL = 'https://script.google.com/macros/s/AKfycbzX32uMGszy7AOIa1EcwnaXrYg50fXEiAWO0F2-tjzmg87CtvNbO-JZpclwX_j0Q6LlbQ/exec';

  // 로그인 페이지에서 저장한 팀 정보 불러오기
  const team = localStorage.getItem('team') || '';

  function goBack() {
    location.href = 'index.html';
  }

  function onScanSuccess(decodedText, decodedResult) {
    const parts = decodedText.split(',');
    if(parts.length !== 2) {
      alert('올바른 위치 정보가 담긴 QR 코드가 아닙니다.');
      return;
    }

    const latitude = parts[0].trim();
    const longitude = parts[1].trim();
    const datetime = new Date().toISOString();

    const postData = {
      team: team,
      qrData: decodedText,
      latitude: latitude,
      longitude: longitude,
      datetime: datetime,
    };

    fetch(SERVER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(postData),
    })
    .then(res => res.json())
    .then(data => {
      if(data.result === 'success') {
        alert('출석이 성공적으로 기록되었습니다.');
      } else {
        alert('출석 기록에 실패했습니다.');
      }
    })
    .catch(err => {
      console.error('서버 전송 오류:', err);
      alert('서버와 연결할 수 없습니다.');
    });
  }

  function onScanFailure(error) {
    // 실패시 로그 출력 등 필요시 추가 가능
  }

  const html5QrCode = new Html5Qrcode("reader");

  html5QrCode.start(
    { facingMode: "environment" },
    {
      fps: 10,
      qrbox: 300
    },
    onScanSuccess,
    onScanFailure
  ).catch(err => {
    console.error("카메라 시작 실패:", err);
    alert("카메라를 사용할 수 없습니다.");
  });
</script>

</body>
</html>
