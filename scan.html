<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR 코드 스캔</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-size: 28px;
      display: flex; flex-direction: column;
    }
    #back-button {
      font-size: 28px;
      padding: 10px 20px;
      background: none;
      border: none;
      color: #007bff;
      cursor: pointer;
      text-align: left;
      user-select: none;
      outline: none;
    }
    #reader {
      flex: 1;
      width: 100%;
    }
  </style>
</head>
<body>

<button id="back-button" onclick="goBack()">&lt; 뒤로가기</button>

<div id="reader"></div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  const SERVER_URL = 'https://your-google-apps-script-webapp-url'; // 실제 서버 주소로 변경하세요

  // 로그인 페이지에서 저장한 팀 정보 불러오기
  const team = localStorage.getItem('team') || '';

  function goBack() {
    // 뒤로가기 누르면 로그인 페이지로 돌아가기
    location.href = 'index.html';
  }

  function onScanSuccess(decodedText, decodedResult) {
    // QR 코드 내용 예: "37.5665,126.9780"
    const parts = decodedText.split(',');
    if(parts.length !== 2) {
      alert('올바른 위치 정보가 담긴 QR 코드가 아닙니다.');
      return;
    }

    const latitude = parts[0].trim();
    const longitude = parts[1].trim();
    const datetime = new Date().toISOString();

    const postData = {
      team: team,
      qrData: decodedText,
      latitude: latitude,
      longitude: longitude,
      datetime: datetime,
    };

    // 서버에 출석 정보 전송
    fetch(SERVER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(postData),
    })
    .then(res => res.json())
    .then(data => {
      if(data.result === 'success') {
        alert('출석이 성공적으로 기록되었습니다.');
      } else {
        alert('출석 기록에 실패했습니다.');
      }
    })
    .catch(err => {
      console.error('서버 전송 오류:', err);
      alert('서버와 연결할 수 없습니다.');
    });
  }

  function onScanFailure(error) {
    // 스캔 실패 시 동작(필요하면 로그 등)
  }

  // 후면 카메라 자동 실행 설정
  const html5QrCode = new Html5Qrcode("reader");
  const config = {
    fps: 10,
    qrbox: 300,
    facingMode: { exact: "environment" }  // 후면 카메라 지정
  };

  html5QrCode.start(
    config.facingMode,
    config,
    onScanSuccess,
    onScanFailure
  ).catch(err => {
    console.error("카메라 시작 실패:", err);
    alert("카메라를 사용할 수 없습니다.");
  });
</script>

</body>
</html>
