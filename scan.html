<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR 코드 스캔</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-size: 28px;
      display: flex; flex-direction: column;
    }
    #back-button {
      font-size: 28px;
      padding: 10px 20px;
      background: none;
      border: none;
      color: #007bff;
      cursor: pointer;
      text-align: left;
      user-select: none;
      outline: none;
    }
    #reader {
      flex: 1;
      width: 100%;
    }
  </style>
</head>
<body>

  <button id="back-button" onclick="goBack()">&lt; 뒤로가기</button>
  <div id="reader"></div>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script>
    const SERVER_URL = 'https://script.google.com/macros/s/AKfycbx1krcZyWLDPqLUjuS9vN824g9vO51maYcLY3Jw0Y3OwWafgmJKOAKmyqU6-Hlz5zjW3Q/exec';
    const team = localStorage.getItem('team') || '';

    function goBack() {
      location.href = 'index.html';
    }

    function onScanSuccess(decodedText, decodedResult) {
      const datetime = new Date().toISOString();

      if (!team) {
        alert("로그인 정보가 없습니다. 다시 로그인 해주세요.");
        window.location.href = "index.html";
        return;
      }

      if (!navigator.geolocation) {
        alert("이 기기에서는 위치 기능을 지원하지 않습니다.");
        return;
      }

      navigator.geolocation.getCurrentPosition(position => {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;

        const postData = {
          team,
          qrData: decodedText, // 실제 내용은 무시됨
          latitude,
          longitude,
          datetime
        };

        fetch(SERVER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(postData),
        })
        .then(res => res.json())
        .then(data => {
          if(data.result === 'success') {
            alert('순찰이 성공적으로 기록되었습니다.');
          } else {
            alert('순찰 기록에 실패했습니다.');
          }
        })
        .catch(err => {
          console.error('서버 전송 오류:', err);
          alert('서버와 연결할 수 없습니다.');
        });

      }, () => {
        alert("위치 접근이 거부되었습니다.");
      });
    }

    function onScanFailure(error) {
      // 실패 시 로그만
    }

    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 300 },
      onScanSuccess,
      onScanFailure
    ).catch(err => {
      console.error("카메라 시작 실패:", err);
      alert("카메라를 사용할 수 없습니다.");
    });
  </script>

</body>
</html>
