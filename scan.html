<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR 코드 스캔</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-size: 24px; /* 글씨 크게 */
      display: flex; flex-direction: column;
    }
    #reader {
      flex: 1;
      width: 100%;
    }
    #back-button {
      font-size: 28px;
      padding: 10px 20px;
      background: none;
      border: none;
      color: #007bff;
      cursor: pointer;
      text-align: left;
      user-select: none;
      outline: none;
    }
  </style>
</head>
<body>

<button id="back-button" onclick="goBack()">&lt; 뒤로가기</button>

<div id="reader"></div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  const SERVER_URL = 'https://your-google-apps-script-webapp-url'; // 실제 URL로 교체
  const team = localStorage.getItem('team') || ''; // 로그인 후 저장된 팀 정보 불러오기

  function goBack() {
    window.history.back();
  }

  function onScanSuccess(decodedText, decodedResult) {
    // QR코드 스캔 성공 시 실행

    // QR 코드 예: "37.5665,126.9780" 형태 가정
    const parts = decodedText.split(',');
    if(parts.length !== 2) {
      alert('올바른 위치 정보가 담긴 QR 코드가 아닙니다.');
      return;
    }

    const latitude = parts[0].trim();
    const longitude = parts[1].trim();
    const datetime = new Date().toISOString();

    const postData = {
      team: team,
      qrData: decodedText,
      latitude: latitude,
      longitude: longitude,
      datetime: datetime,
    };

    // 서버로 POST
    fetch(SERVER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(postData),
    })
    .then(response => response.json())
    .then(data => {
      if(data.result === 'success') {
        alert('출석이 성공적으로 기록되었습니다.');
        // 스캔 계속 진행 가능 또는 다른 동작 추가 가능
      } else {
        alert('출석 기록에 실패했습니다.');
      }
    })
    .catch(error => {
      console.error('서버 전송 오류:', error);
      alert('서버와 연결할 수 없습니다.');
    });
  }

  function onScanFailure(error) {
    // 실패 시 실행(선택적)
    // console.warn(`스캔 실패: ${error}`);
  }

  const html5QrcodeScanner = new Html5QrcodeScanner(
    "reader", { fps: 10, qrbox: { width: 300, height: 300 }, 
                facingMode: "environment" }, /* 후면 카메라 */
  );
  html5QrcodeScanner.render(onScanSuccess, onScanFailure);
</script>

</body>
</html>
