<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>QR코드 출석</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; }
    button { font-size: 20px; padding: 10px; margin-top: 30px; cursor: pointer; width: 100%; }
    #result { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>QR코드 출석</h2>
  <p>팀: <span id="teamName"></span></p>

  <button id="scanBtn">QR 코드 스캔 시작</button>

  <div id="result"></div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    // 저장소에서 팀 불러오기
    const team = localStorage.getItem("team") || "알 수 없음";
    document.getElementById("teamName").textContent = team;

    const scanBtn = document.getElementById("scanBtn");
    const resultDiv = document.getElementById("result");

    // 구글 앱스 스크립트 웹앱 URL 넣기 (나중에 수정 필요)
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx.../exec";

    // 위치 정보 요청 함수
    function getLocationAndSend(qrData) {
      if (!navigator.geolocation) {
        alert("위치 정보를 지원하지 않는 브라우저입니다.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          const now = new Date();
          const timestamp = now.toLocaleString();

          // 데이터 전송용 객체
          const data = {
            team: team,
            qr: qrData,
            latitude: latitude,
            longitude: longitude,
            timestamp: timestamp,
          };

          // 구글 스프레드시트에 데이터 전송
          fetch(GOOGLE_SCRIPT_URL + 
            `?team=${encodeURIComponent(data.team)}&qr=${encodeURIComponent(data.qr)}&lat=${data.latitude}&lon=${data.longitude}&time=${encodeURIComponent(data.timestamp)}`)
            .then((res) => res.text())
            .then((text) => {
              resultDiv.textContent = "출석 완료! 데이터가 기록되었습니다.";
            })
            .catch((err) => {
              resultDiv.textContent = "데이터 전송 중 오류가 발생했습니다.";
              console.error(err);
            });
        },
        (err) => {
          alert("위치 정보를 가져오지 못했습니다.");
          console.error(err);
        }
      );
    }

    // QR 코드 스캔 시작
    scanBtn.addEventListener("click", () => {
      const html5QrCode = new Html5Qrcode("reader");

      Html5Qrcode.getCameras()
        .then((devices) => {
          if (devices && devices.length) {
            // 후면 카메라 우선 선택
            const backCamera = devices.find(camera => camera.label.toLowerCase().includes('back')) || devices[0];
            const cameraId = backCamera.id;

            html5QrCode.start(
              cameraId,
              { fps: 10, qrbox: 250 },
              (decodedText) => {
                html5QrCode.stop();
                getLocationAndSend(decodedText);
              },
              (errorMessage) => {
                // 스캔 실패 시 무시
              }
            );
          } else {
            alert("사용 가능한 카메라가 없습니다.");
          }
        })
        .catch((err) => {
          alert("카메라를 사용할 수 없습니다.");
          console.error(err);
        });
    });
  </script>

  <!-- QR코드 스캔 뷰 영역 -->
  <div id="reader" style="width: 100%; margin-top: 20px;"></div>
</body>
</html>
